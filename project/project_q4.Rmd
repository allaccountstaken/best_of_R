---
title: "project_q4"
author: "Dima Mikhaylow"
date: "10/9/2021"
output: html_document
---

```{r}
library(tidyverse)
```



```{r}
df <- read_csv("diamonds4.csv", show_col_types = FALSE)
```

#### Scatterplot analysis y=Price agains x=Carat:

```{r}
ggplot(df, aes(x=carat, y=price))+
  geom_point()+
  geom_smooth(method = "lm", se = TRUE)+
  labs(x="Carat", y="Price",
       title="Regression line Price against Carat")
```
#### Fitting a `base_model` with no transformations:

```{r}
base_model = lm(price ~ carat, data=df)
summary(base_model)
```

#### Meaningless intercept but significant predictor as measured by F-statistic, only moderate R-squared of 68%. 

#### Check SLM assumptions. Below is analysis of residuals from the `base_model`:

```{r}
y_hat <- base_model$fitted.values
residuals_0 <- base_model$residuals
df <- data.frame(df, y_hat, residuals_0)

ggplot(df, aes(x=y_hat, y=residuals_0))+
  geom_point()+
  geom_hline(yintercept = 0, color='red')+
  labs(x="Fitted y", y="Residuals", title= "Residual plot from the `base_model` before any transformation")
```

#### From the Residual plot above, at leaset 2 assumptions seeem to be violated: 1) mean of errors is not zero as there is a cluster below the horizontal line on the range (0, 50,000); 2) variance also tends to increase with larger values.

#### Check for a good transformation of the response variable is used to remedy non-constant variance. Box Cox does not give a range of lambdas in this case...

```{r}
boxcox(price ~ carat, data = df)
```

#### Next check for possible auto-correlations in predictor with ACF. Consider possible x transformation to correct for lag 3 correlation:


```{r}
acf(residuals_0, main="ACF Plot of Residuals for the original x")

```


#### Finally check for normality of residuals from the `base_model`, not looking normal at all:

```{r}
qqnorm(residuals_0)
```


#### Start with y transformation - use a convex function, sqrt() or log(). Transformation #1 - taking a square root of response, `y_sqrt`. This produces set of transformed residuals_1 

```{r}
price_sqrt <- sqrt(df$price)
df <- data.frame(df, price_sqrt)

model.price_sqrt <- lm(price_sqrt ~ carat, data=df)

price_sqrt_hat1 <- model.price_sqrt$fitted.values
residuals_1 <- model.price_sqrt$residuals
df <- data.frame(df, price_sqrt_hat1, residuals_1)

##residual plot with xstar
ggplot(df, aes(x=price_sqrt_hat1, y=residuals_1))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot after sqrt y transformation")

```

#### Residuals are looking better at least in terms of mean could be zero now, but 2) variance is still increasing with `price_sqrt_hat`:

```{r}
ggplot(df, aes(x=carat, y=price_sqrt))+
  geom_point()+
  geom_smooth(method = "lm", se = TRUE)+
  labs(x="Carat", y="Sqrt of Price",
       title="Regression line Sqrt of Price against Carat")
```

```{r}
qqnorm(residuals_1)
```


#### As shown below, sqrt model is much stronger in terms of R-squared (93%.)

```{r}
summary(model.price_sqrt)
```


#### Still need to consider adjustment to the predicter. Possibly log transformation of x will produce a better set of residuals_2

```{r}
carat_log <- log(df$carat)
df <- data.frame(df,carat_log)

result.carat_log <- lm(price_sqrt ~ carat_log, data=df)

price_sqrt_hat2 <- result.carat_log$fitted.values
residuals_2 <- result.carat_log$residuals
df <- data.frame(df,price_sqrt_hat2,residuals_2)

##residual plot with xstar
ggplot(df, aes(x=price_sqrt_hat2,y=residuals_2))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot after log x and sqrt y transormation")

```
#### Still  “cone” shape is a telltale sign of heteroscedasticity. Obviously, residuals are not notmal:

```{r}
qqnorm(residuals_2)
```

#### It seems it make it worse. Let's try sqrt x transformation instead of log:

```{r}

carat_sqrt <- log(df$carat)
df <- data.frame(df,carat_sqrt)

result.carat_sqrt <- lm(price_sqrt ~ carat_sqrt, data=df)

price_sqrt_hat3 <- result.carat_sqrt$fitted.values
residuals_3 <- result.carat_sqrt$residuals
df <- data.frame(df,price_sqrt_hat3,residuals_3)

##residual plot with xstar
ggplot(df, aes(x=price_sqrt_hat3,y=residuals_3))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot after log x and sqrt y transormation")
```


#### Alternatively, one can try relative model, i.e. price per carat

```{r}
relative_model <- lm(price/carat ~ carat, data=df)
summary(relative_model)
```

```{r}

price_rel_hat <- relative_model$fitted.values
residuals_4 <- relative_model$residuals
df <- data.frame(df,price_rel_hat,residuals_4)

##residual plot with xstar
ggplot(df, aes(x=price_rel_hat,y=residuals_4))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot after log x transormation")
```

#### Since heteroscedasticity is clearly present, we could also perform weighted least squares by defining the weights in such a way that the observations with lower variance are given more weight:


```{r}
#define weights to use
weights <- 1 / lm(abs(base_model$residuals) ~ base_model$fitted.values)$fitted.values^2

#perform weighted least squares regression
weighted_model <- lm(price ~ carat, data = df, weights=weights)


price_weighted_hat <- weighted_model$fitted.values
residuals_5 <- weighted_model$residuals
df <- data.frame(df,price_weighted_hat,residuals_5)

##residual plot with xstar
ggplot(df, aes(x=price_weighted_hat,y=residuals_5))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot for Weighted Least Squares Regression")
```

```{r}

#define weights to use
weights <- 1 / lm(abs(sqrt_weighted_model$residuals) ~ sqrt_weighted_model$fitted.values)$fitted.values^2

#perform weighted least squares regression
sqrt_weighted_model <- lm(sqrt(price) ~ carat, data = df, weights=weights)




price_sqrt_weighted_hat <- sqrt_weighted_model$fitted.values
residuals_8 <- sqrt_weighted_model$residuals
df <- data.frame(df,price_sqrt_weighted_hat,residuals_8)

##residual plot with xstar
ggplot(df, aes(x=price_sqrt_weighted_hat,y=residuals_8))+
  geom_point()+
  geom_hline(yintercept=0, color="red")+
  labs(x="Fitted y", y="Residuals", title="Residual Plot for Log Weighted Least Squares Regression")
```
```




